# Créer des cartes avec Tmap

Tmap est un package dédié à la réalisation de carte sous R.
La syntaxe est très proche de ggplot,avec l'opérateur "+" pour enchainer les options. 
L'équivalent des `geom_xx()` dans tmap sont les fonctions suivantes : 

- `tm_lines()` : afficher des lignes
- `tm_polygons()` : afficher des polygones
- `tm_raster()` : afficher un raster
- `tm_bubbles()` : afficher des ronds proportionnels
- `tm_markers()` : afficher des marqueurs
- `tm_text()` : afficher du texte

Pour charger une donnée géométrique, il faut utiliser la fonction `tm_shape()`


Les différences avec `ggplot2` :

- Les variables s'appellent dans des cotes "" ;
- Le facetting peut se faire sur un format de données large (une carte par colonne et non une carte par modalité d'une variable) ;
- La grande différence entre les `tm_xx()` et les `geom_xx()`, c'est que les `tm_xx()`  inclus la définition des *classes* (nombre de classe, définition des classes et des palettes) sans passer par une fonction `scale()`  dont l'équivalant n'existe pas.

La mise en page se définit avec la fonction `tm_layout()`, la légende avec `tm_legend()`


## Exemple de carte choroplèthe

La fonction `tm_polygons()` permet de faire des cartes choroplèthe.

```{r, echo=T,eval=T,fig.height=5,fig.width=12}
sdg_indicators_sf %>% 
  filter(timeperiod == "2015") %>% 
  tm_shape()+
  tm_polygons("sh_sta_mmr")+
  tm_borders("white", lwd = .5)
```

L'option `n=` permet de sélectionner le nombre de classes souhaitées lorsque l'on réalise une carte sur une variable continue

```{r, echo=T,eval=T,fig.height=5,fig.width=12}
sdg_indicators_sf %>% 
  filter(timeperiod == "2015") %>% 
  tm_shape()+
  tm_polygons("sh_sta_mmr",n=3)
```

## Exemple de carte à ronds proportionnels

La fonction `tm_bubble()` permet de faire des cartes à ronds proportionnels. L'utilisation de `tm_polygons()` permet sans lui spécifier de paramètre d'afficher les frontière des pays avec une couleur de remplissage par défaut.

```{r, echo=T,eval=T,fig.height=5,fig.width=12}
sdg_indicators_sf %>% 
  filter(timeperiod == "2015") %>% 
  tm_shape()+
  tm_polygons()+
  tm_bubbles(size="sh_sta_mmr",col="sh_sta_mmr")
```

## Exemples de cartes avec facet

`tm_facets()` permet de réaliser des cartes à facette avec la même logique que celle de `ggplot2`.

```{r, echo=T,eval=T,fig.height=5,fig.width=8}
sdg_indicators_sf %>% 
  filter(timeperiod %in% c("2000","2005","2010","2015")) %>% 
  tm_shape()+
  tm_polygons("sh_sta_mmr")+
  tm_facets("timeperiod")
```

```{r, echo=T,eval=T,fig.height=5,fig.width=8}
sdg_indicators_sf %>% 
  filter(timeperiod == "2015") %>% 
  tm_shape()+
  tm_polygons("sh_sta_mmr")+
  tm_facets("continent")
```

## gestion des palettes

La fonction `tmaptools::palette_explorer()` permet d'accéder à une interface très simple de définition d'une palette de couleur à partir des palette *brewer*.

```{r, echo=T,eval=T,fig.height=5,fig.width=8}
sdg_indicators_sf %>% 
  filter(timeperiod == "2015") %>% 
  tm_shape()+
  tm_polygons("sh_sta_mmr",palette=get_brewer_pal("OrRd", n = 5, contrast = c(0.2, 1)))
```

On peut également utiliser n'importe qu'elle palette, par exemple la pelette viridis, mais sans l'interface proposée par `palette_explorer()` : 

```{r, echo=T,eval=T,fig.height=5,fig.width=8}
sdg_indicators_sf %>% 
  filter(timeperiod == "2015") %>% 
  tm_shape()+
  tm_polygons("sh_sta_mmr",palette=viridis(5, alpha = 1, begin = 0.3, end = 1, direction = 1, option = "D"))
```

## La mise en page

`tm_layout()` permet de controler les polices, la légende, les marges, les couleurs.
l'option `design.mode=T` permet de voir visuellement les marges,la position de la légende.
Le titre de la légende ne se défini pas dans `tm_layout()` mais dans `tm_polygons()`. L'option `title` de ces fonctions est l'équivalent d'un libellé de la variable mise dans l'aesthetic.

```{r, echo=T,eval=T,fig.height=5,fig.width=8}
sdg_indicators_sf %>% 
  filter(timeperiod == "2015") %>% 
  tm_shape()+
  tm_polygons("sh_sta_mmr",palette=viridis(5, alpha = 1, begin = 0.3, end = 1, direction = 1, option = "D"),
              title="Taux de mortalité de la mère \n(pour 100 000 naissances)")+
  tm_layout(main.title="Taux de mortalité de la mère \n(pour 100 000 naissances) dans le monde",
            main.title.size=1.2,
            bg.color = "skyblue",
            legend.position=c("left","bottom"),
            legend.bg.color = "white",
            legend.bg.alpha = .4,
            legend.outside = F,
            main.title.position = "center")
```

Avec les cartes en ronds proportionnels,on peut spécifier un titre pour la couleur et la taille du rond.

```{r, echo=T,eval=T,fig.height=5,fig.width=8}
sdg_indicators_sf %>% 
  filter(timeperiod == "2015") %>% 
  tm_shape()+
  tm_polygons()+
  tm_bubbles(size="sh_sta_mmr",col="sh_sta_mmr",
             palette=viridis(5, alpha = 1, begin = 0, end = 1, direction = 1, option = "D"),
              title.col="",
              title.size="Taux de mortalité de la mère \n(pour 100 000 naissances)")+
  tm_layout(main.title="Taux de mortalité de la mère \n(pour 100 000 naissances) dans le monde",
            main.title.size=1.2,
            outer.margins=c(0,0,0,0),
            legend.position=c("left","bottom"),
            legend.outside = F,
            main.title.position = "center",
            inner.margins = c(0, 0, 0, 0))
```

## Export d'une carte

La fonction `tmap_save()`  permet d'exporter une carte tmap en fichier image.

```{r echo=T,eval=F,fig.height=5,fig.width=8}
sdg_indicators_sf %>% 
  filter(timeperiod == "2015") %>% 
  tm_shape()+
  tm_polygons()+
  tm_bubbles(size="sh_sta_mmr",col="sh_sta_mmr",
             palette=viridis(5, alpha = 1, begin = 0.3, end = 1, direction = 1, option = "D"),
              title.col="",
              title.size="Taux de mortalité de la mère \n(pour 100 000 naissances)")+
  tm_layout(main.title="Taux de mortalité de la mère \n(pour 100 000 naissances) dans le monde",
            main.title.size=1.2,
            outer.margins=c(0,0,0,0),
            legend.position=c("left","bottom"),
            legend.outside = F,
            main.title.position = "center",
            inner.margins = c(0, 0, 0, 0))

tmap_save(carte,filename="figures/Taux de mortalité de la mère dans le monde.png")
```


## Exercice 5 


> Produire une carte du Loiret  à l'EPCI du taux de logements collectifs dans le parc locatif social.

Résultat attendu


```{r eval=T,echo=F,message=F,warning=F}
tt<-Carte_EPCI_France %>% 
  filter(CODE_DEPT=="45") %>% 
  left_join(rpls_aggrege) %>% 
  filter(Indicateur=="Logements collectifs_pourcent")
ggplot(data=tt)+
  geom_sf(aes(fill=Valeur))+
  labs(title="Taux de logements collectifs par EPCI",subtitle="Département du Loiret")+
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank())
```


