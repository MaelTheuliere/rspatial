# Créer des cartes pour le web

## Les cartes Leaflet

Leaflet est au départ un package de cartographique réalisé en javascript. R permet de produire des cartes en exploitant cette librairie.

Ci-dessous un exemple avancé de carte choroplète avec leaflet.

```{r}

tt<-World %>%
  rename(Country_or_Area_Code=iso_a3) %>%
  left_join(indicateur311 %>%
              filter(Age_group=="All age ranges or no breakdown by age",
                     Sex=="Both sexes or no breakdown by sex",
                     Type_Zone=="Pays",
                     is.na(Value_type)) %>%
              group_by(Country_or_Area_Code) %>%
              filter(!is.na(Value)) %>%
              filter(Year==max(Year)))
# création des quantiles de la variable d'intérêt
bins <-quantile(tt$Value,na.rm=T)
# création d'une palette de couleurs associée
pal <- colorBin("YlOrRd", domain = tt$Value, bins = bins)
#création d'un label ad hoc à afficher en surbrillance au passage de la souris sur la carte.
labels <- sprintf(
  "<strong>%s</strong><br/>%g décès pour 100 000 naissance en 2015",
  tt$name, tt$Value
) %>% lapply(htmltools::HTML)
#transformation de la projection nécessaire pour certaines cartes car Leaflet ne connait que le WGS 84
tt<-st_transform(tt,crs=("+proj=longlat +datum=WGS84 +no_defs"))

leaflet(tt) %>%
  addPolygons(data=tt,
              fillColor=~pal(Value),
              weight = 2,
              opacity = 1,
              color = "white",
              dashArray = "3",
              fillOpacity = 0.7,
              highlight = highlightOptions(
                weight = 5,
                color = "#666",
                dashArray = "",
                fillOpacity = 0.7,
                bringToFront = TRUE),
              label = labels,
              labelOptions = labelOptions(
                style = list("font-weight" = "normal", padding = "3px 8px"),
                textsize = "15px",
                direction = "auto"))


```

Pour réaliser des ronds proportionnel, il va falloir la aussi créer un centroide de nos polygones

```{r}
ttc<-st_centroid(tt)

bins <-quantile(ttc$Value,na.rm=T)
pal <- colorBin("YlOrRd", domain = ttc$Value, bins = bins)

carte_rond_proportionnel<-leaflet(ttc) %>%
  addPolygons(data=tt,
              fillColor = "#ffffff",
                opacity=.2,
              color = "white",
              dashArray = "3",
              fillOpacity = 0.7
  ) %>% 
  addCircles(data=ttc,
              fillColor=~pal(Value),
             radius=~100000*log2(Value),
              weight = 2,
              opacity = 1,
              color = "white",
              dashArray = "3",
              fillOpacity = 0.7,
              highlight = highlightOptions(
                weight = 5,
                color = "#666",
                dashArray = "",
                fillOpacity = 0.7,
                bringToFront = TRUE),
              label = labels,
              labelOptions = labelOptions(
                style = list("font-weight" = "normal", padding = "3px 8px"),
                textsize = "15px",
                direction = "auto")) %>% 
  addLegend("bottomright", pal = pal, values = ~Value,
            title = "Taux de décès des mères à la naissance",
            opacity = 1)
carte_rond_proportionnel
```

## Exporter une sortie html

La foncion `saveWidget` permet d'exporter une sotie d'un html Widget en html.

```{r, eval=T}
saveWidget(widget=carte_rond_proportionnel,file="Taux de décès des mères à la naissance.html")
```
